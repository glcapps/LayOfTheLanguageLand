<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Languages Demo in Browser</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='black'>💾</text></svg>">
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.0/flowbite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@electric-sql/pglite/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        function base64ToUint8Array(base64) {
            const binary_string = atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
                if (bytes[i] > 255) {
                throw new Error("Either atob or string iteration is not spec compliant, please make sure your runtime is supported");
                }
            }
            return bytes;
        }
    </script>
    <script>
        //shim the json stringify problem for BigInt
        BigInt.prototype.toJSON = function () {
            return JSON.rawJSON(this.toString());
        };
    </script>
    <!-- Pyodide for Python -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <!-- sql.js for SQLite -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <!-- TypeScript Compiler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.4.3/typescript.min.js"></script>

    <!-- Lua via Fengari -->
    <script src="https://unpkg.com/fengari-web@0.1.4/dist/fengari-web.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opal-runtime@3.0.0/src/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/biwascheme@0.8.0/release/biwascheme.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/lib/core.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/an-old-hope.min.css" rel="stylesheet">

    <!-- YAML support -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>


</head>
<body class="bg-gray-900 text-white p-6">

    <!-- Load Monaco separately to avoid exceptions breaking other functionality -->
    <script>
        (function() {
            try {
                var monacoScript = document.createElement("script");
                monacoScript.src = "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.js";
                monacoScript.onload = function() {
                    require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs" } });
                    require(["vs/editor/editor.main"], function () {
                        window.monacoLoaded = true;
                        console.log("Monaco Editor Loaded Successfully");
                    });
                };
                document.head.appendChild(monacoScript);
            } catch (e) {
                console.error("Failed to load Monaco Editor:", e);
            }
        })();
    </script>

    <!-- Load Apache Arrow explicitly -->
    <script type="module">
        import * as arrow from "https://cdn.jsdelivr.net/npm/apache-arrow@19.0.0/Arrow.es2015.min.js";
        window.arrow = arrow;
    </script>
    <!-- Load all dependencies locally -->
    <script type="module">
        // import * as arrow from "./apache-arrow-mjs.js";   
        import * as tslib from "./tslib-mjs.js";         
        import * as flatbuffers from "./flatbuffers-mjs.js"; 
        import * as duckdb from "./duckdb-browser-mjs.js";  

        // Ensure global access to dependencies
        window.arrow = arrow;
        window.tslib = tslib;
        window.flatbuffers = flatbuffers;
        window.duckdb = duckdb;
        window.duckDBReady = false; // Mark DuckDB as not ready initially

        async function initDuckDB() {
            console.log("Initializing DuckDB...");

            const MANUAL_BUNDLES = {
                mvp: {
                    mainModule: "./duckdb-mvp.wasm",
                    mainWorker: "./duckdb-browser-mvp.worker.js",
                },
            };

            // Select the appropriate bundle
            const bundle = await duckdb.selectBundle(MANUAL_BUNDLES);
            console.log("Bundle Selected:", bundle);

            // Create a worker with the correct path
            const worker = new Worker(bundle.mainWorker);
            const logger = new duckdb.ConsoleLogger();

            // Instantiate DuckDB with explicit Arrow module
            const db = new duckdb.AsyncDuckDB(logger, worker);
            await db.instantiate(bundle.mainModule, bundle.pthreadWorker, {
                arrowModule: window.arrow, // Ensure Apache Arrow is correctly passed
            });

            console.log("DuckDB Successfully Initialized.");
            window.duckDB = db; // Store DuckDB globally
            window.duckDBReady = true; // Mark DuckDB as ready
        }

        // Wait for DuckDB to initialize before running queries
        await initDuckDB();
    </script>
    <script>
        function generateTableFromJson(jsonData) {
            if (!Array.isArray(jsonData) || jsonData.length === 0) return "<p>No data available</p>";
            
            const columns = Object.keys(jsonData[0]);
            
            let table = `<table class="table-auto w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-600">`;
            
            columns.forEach(column => {
                table += `<th class="border border-gray-300 px-4 py-2 cursor-pointer" onclick="sortTable('${column}')">${column}</th>`;
            });
            
            table += `</tr>
                     </thead>
                     <tbody>`;
            
            jsonData.forEach(row => {
                table += `<tr class="border border-gray-300">`;
                columns.forEach(column => {
                    table += `<td class="border border-gray-300 px-4 py-2">${row[column]}</td>`;
                });
                table += `</tr>`;
            });
            
            table += `</tbody>
                    </table>`;
            
            return table;
        }
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Load article from hash if present on page load, or default to webstack-cartoon.png
      const initialHash = window.location.hash.slice(1);
      let articlePath = initialHash || "webstack-cartoon.png";
      if (!/\.(png|jpg|jpeg|gif|webp)$/i.test(articlePath)) {
        articlePath += ".md";
      }
      htmx.ajax("GET", articlePath, "#content");

      // Update hash on navigation click
      document.querySelectorAll("a[hx-get]").forEach(link => {
        link.addEventListener("click", (e) => {
          const fileName = link.getAttribute("hx-get");
          if (fileName) {
            const articleName = fileName.replace(/\.md$/, "");
            history.replaceState(null, "", "#" + articleName);
          }
        });
      });

      htmx.on("htmx:afterSwap", (e) => {
        if (e.detail.target.id === "content") {
          const url = e.detail.xhr.responseURL || "";
          if (!window.location.hash || url.endsWith("webstack-cartoon.png")) {
            const image = `<img src="webstack-cartoon.png" alt="WebStack Cartoon" class="mx-auto my-6 rounded shadow" style="max-height: 100vh; max-width: 100vw;" />`;
            document.getElementById("content").innerHTML = image;
            return;
          }
          const converter = new showdown.Converter({
            simpleLineBreaks: true,
            simplifiedAutoLink: true,
            excludeTrailingPunctuationFromURLs: true,
            literalMidWordUnderscores: true,
            strikethrough: true,
            tables: true,
            openLinksInNewWindow: true,
            emoji: true,
            ghCompatibleHeaderId: true,
            smoothLivePreview: true,
            parseImgDimensions: true,
            requireSpaceBeforeHeadingText: true
          });
          // Preprocess raw Markdown: add spacing for blank lines contextually
          let rawText = e.detail.xhr.responseText;

          // Step 1: Normalize to Unix newlines
          rawText = rawText.replace(/\r\n/g, '\n');

          // Step 2: Tokenize blank lines (preserving Markdown structure)
          rawText = rawText
            .replace(/\n{3,}/g, '\n<!--BLANK_BLOCK-->\n')    // Three or more blank lines
            .replace(/\n{2}/g, '\n<!--BLANK_LINE-->\n');     // Exactly one blank line between content

          let html = converter.makeHtml(rawText);

          html = html
            .replace(/<h1[^>]*>([\s\S]*?)<\/h1>/g, '<h1 class="text-3xl font-extrabold mt-10 mb-6 border-b pb-2">$1</h1>')
            .replace(/<h2[^>]*>([\s\S]*?)<\/h2>/g, '<h2 class="text-2xl font-bold mt-8 mb-4">$1</h2>')
            .replace(/<h3[^>]*>([\s\S]*?)<\/h3>/g, '<h3 class="text-xl font-semibold mt-6 mb-2">$1</h3>')
            .replace(/<h4[^>]*>([\s\S]*?)<\/h4>/g, '<h4 class="text-lg font-medium mt-4 mb-2">$1</h4>');

          html = html
            .replace(/<!--BLANK_BLOCK-->/g, '<div class="my-4">&nbsp;</div>')
            .replace(/<!--BLANK_LINE-->/g, '<div class="my-1">&nbsp;</div>');

          rawText = rawText.replace(/<div class="my-[23]">&nbsp;<\/div>/g, "\n");

          html = html
            .replace(/<<BLANK_BLOCK>>/g, '<div class="my-4">&nbsp;</div>')
            .replace(/<<BLANK_LINE>>/g, '<div class="my-1">&nbsp;</div>');

          // Extract the first heading as title
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          // Style all tables
          tempDiv.querySelectorAll("table").forEach(table => {
            table.classList.add("table-auto", "w-full", "border", "border-gray-300");
            table.querySelectorAll("th").forEach(th => th.classList.add("border", "bg-gray-100", "px-4", "py-2", "text-left"));
            table.querySelectorAll("td").forEach(td => td.classList.add("border", "px-4", "py-2"));
          });
          // Style all unordered and ordered lists
          tempDiv.querySelectorAll("ul").forEach(ul => {
            ul.classList.add("list-disc", "pl-6", "mb-4");
          });
          tempDiv.querySelectorAll("ol").forEach(ol => {
            ol.classList.add("list-decimal", "pl-6", "mb-4");
          });
          tempDiv.querySelectorAll("li").forEach(li => {
            li.classList.add("mb-1");
          });
          const firstHeading = tempDiv.querySelector("h1, h2");
          if (firstHeading) {
            firstHeading.classList.add("text-3xl", "font-bold", "mb-4", "border-b", "pb-2");
          }

          document.getElementById("content").innerHTML = tempDiv.innerHTML;
        }
      });
    });
  </script>
</head>
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">Navigating Code, Communication, Interviews, and Career Conversations</h1>
        <main class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <nav class="space-y-2 md:col-span-1">
            <h2 class="text-xl font-semibold mb-2">Table of Contents</h2>
            <ul class="space-y-1" x-data="{ articles: [
                { file: 'webstack-cartoon.png', title: 'WebStack Cartoon' },
                { file: 'language-vs-framework.md', title: 'What\'s the Real Developer Experience?' },
                { file: 'language-compass.md', title: 'The Language Compass' },
                { file: 'reactive.md', title: 'What Does Reactive Really Mean?' },
                { file: 'responsive.md', title: 'Unpacking Responsive: Layout, Latency, and Reactivity' },
                { file: 'slippery-terms.md', title: 'Slippery Terms in Tech' },
                { file: 'component-vs-webcomponent.md', title: 'Component vs Web Component' },
                { file: 'jsx-in-context.md', title: 'JSX in Context' },
                { file: 'logic-and-markup-boundaries.md', title: 'Logic and Markup Boundaries' },
                { file: 'framework-boundary-contracts.md', title: 'Framework Boundary Contracts' },
                { file: 'declarative-vs-imperative.md', title: 'Declarative vs Imperative' },
                { file: 'interview-vocabulary.md', title: 'Interview Vocabulary and Ambiguity' },
                { file: 'programming-idioms-as-career-signals.md', title: 'Programming Idioms as Career Signals' },
                { file: 'when-to-use-react.md', title: 'When to Use React (and When Not To)' },
                { file: 'htmx-vs-react.md', title: 'HTMX vs React' },
                { file: 'language-and-communication.md', title: 'Language and Communication' },
                { file: 'business-language-translation.md', title: 'Translating Tech to Business Language' },
                { file: 'misunderstood-performance.md', title: 'What Performance Really Means' },
                { file: 'meaning-of-modular.md', title: 'The Meaning of Modular' },
                { file: 'state-vs-state.md', title: 'State vs State' },
                { file: 'mental-models-in-teams.md', title: 'Mental Models in Teams' },
                { file: 'llm-impact-on-code-and-systems.md', title: 'LLM Impact on Code and Systems' },
                { file: 'llm-models-and-language-coverage.md', title: 'LLM Abilities in Languages' },
                { file: 'layers-upon-layers-node-next-nuxt.md', title: 'Node Next Nuxt' },
                { file: 'touch python-ecosystem-and-environment.md', title: 'Python Ecosystem and Environment' },
                { file: 'enterprise-python-tactic.md', title: 'Leveraging the Mojo Compiler to Validate Python Code Beyond Type Checkers' },
                { file: 'languages-often-learned-alongside.md', title: 'Languages Often Learned Alongside' },
                { file: 'database-types-and-models.md', title: 'Database Types and Models' }
            ]}">
                <template x-for="article in articles" :key="article.file">
                <li>
                    <a :href="'#' + article.file.replace(/\.md$/, '')"
                    :hx-get="article.file"
                    hx-target="#content"
                    class="text-blue-600 hover:underline"
                    x-text="article.title">
                    </a>
                </li>
                </template>
            </ul>
            </nav>

            <section id="content" class="prose prose-lg max-w-none md:col-span-3 bg-white text-black p-6 rounded shadow overflow-auto" x-data="{ fontSize: 'prose-lg' }" :class="fontSize">
            <div></div>
            </section>
        </main>
        <br/>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
            <h2 class="text-lg font-semibold mb-2">SQL Data Query</h2>
            <div class="flex gap-2 mb-2">
                <button class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded" onclick="prefillDuckDBQuery(0)">Sample Query</button>
            </div>
            <div id="duckdb-editor" class="h-40 border rounded bg-gray-700"></div>
            <button class="mt-2 bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="runDuckDBQuery()">Run Query</button>
            <!-- Tabs Navigation -->
            <div class="w-full max-w-3xl mx-auto">
                <div class="flex border-b" data-tabs-toggle="#duckdb-tabs">
                    <button id="tab-json" class="px-4 py-2 focus:outline-none" role="tab" data-tabs-target="#jsonTab" aria-selected="true">
                        JSON Output
                    </button>
                    <button id="tab-table" class="px-4 py-2 focus:outline-none" role="tab" data-tabs-target="#tableTab">
                        Table Output
                    </button>
                </div>

                <!-- Tabs Content Container -->
                <div id="duckdb-tabs" class="h-[500px] overflow-hidden">
                    <!-- JSON Tab Content -->
                    <div id="jsonTab" role="tabpanel" class="p-4 h-full overflow-y-auto" aria-labelledby="tab-json">
                        <pre id="duckdb-output" class="overflow-auto p-4 bg-gray-700 border rounded"></pre>
                    </div>

                    <!-- Table Tab Content -->
                    <div id="tableTab" role="tabpanel" class="p-4 h-full overflow-y-auto hidden" aria-labelledby="tab-table">
                        <div id="duckdb-outputTableContainer" class="overflow-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <section id="python-playground" style="margin-top: 3em;">
            <h2>🧪 Python Hello World</h2>
            <button onclick="insertPythonExample()" style="margin-left: 10px;" class="mt-2 bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">Insert Example</button>
            <div id="python-editor" style="height: 200px; border: 1px solid #ccc;"></div>
            <div>
                <button class="mt-2 bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="runPythonCode()">Run Python</button>
            </div>
            <pre id="python-output" style="margin-top: 10px; background: #1a3f15; padding: 1em;"></pre>
            <div id="python-plot" style="margin-top: 1em;"></div>
        </section>

        <section id="rust-demo" class="language-section" style="margin-top: 3em;">
            <h3>Rust Playground</h3>
            <div id="rust-editor" style="height: 200px; border: 1px solid #ccc;"></div>
            <div>
                <button class="mt-2 bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="runRustCode()">Run Rust</button>
            </div>
            <pre id="rustOutput" style="margin-top: 10px; background: #1a3f15; padding: 1em;"></pre>
        </section>

        <section id="terraform-demo" class="language-section" style="margin-top: 3em;">
            <h3>Terraform</h3>
            <div id="terraform-editor" style="height:300px; border:1px solid #ccc;"></div>
            <button class="mt-2 bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="runTerraformCode()">Run Terraform</button>
            <pre id="terraform-output" style="margin-top: 10px; background: #1a3f15; padding: 1em;"></pre>
        </section>
    </div> 

    <script>
        async function runDuckDBQuery() {
            if (!window.duckDBReady) {
                document.getElementById("duckdb-output").textContent = "Error: DuckDB not initialized. Please wait...";
                return;
            }

            const query = window.duckDBEditor.getValue();
            try {
                const conn = await window.duckDB.connect();
                const result = await conn.query(query);
                document.getElementById("duckdb-output").textContent = JSON.stringify(result.toArray(), null, 2);
                document.getElementById("duckdb-outputTableContainer").innerHTML = generateTableFromJson(result.toArray());
                conn.close();
            } catch (error) {
                document.getElementById("duckdb-output").textContent = "Error: " + error.message;
                document.getElementById("duckdb-outputTableContainer").innerHTML = "";
            }
        }

        (function waitForMonaco() {
            if (window.monacoLoaded) {
                window.duckDBEditor = monaco.editor.create(document.getElementById("duckdb-editor"), {
                    value: `SELECT 'Hello, World' AS "greeting"`,
                    language: "sql",
                    theme: "vs-dark"
                });
            } else {
                setTimeout(waitForMonaco, 100);
            }
        })();
    </script>
    <script>
        function prefillDuckDBQuery(queryIndex) {
            const queries = [
                `SELECT 'Hello, World' AS "greeting";`
            ];
            if (window.duckDBEditor && queries[queryIndex]) {
                window.duckDBEditor.setValue(queries[queryIndex]);
            }
        }
    </script>

    <script>
        (function loadPgMock() {
            return
            try {
                var pgMockScript = document.createElement("script");
                pgMockScript.src = "https://cdn.jsdelivr.net/npm/pgmock@latest";
                pgMockScript.onload = function() {
                    console.log("pgMock Loaded Successfully");
                    window.pgMockInstance = new pgMock();
                };
                document.head.appendChild(pgMockScript);
            } catch (e) {
                console.error("Failed to load pgMock:", e);
            }
        })();
    </script>
    
    <script>
        (function enableSQLIntelliSense() {
            if (window.monacoLoaded) {
                monaco.languages.registerCompletionItemProvider("sql", {
                    provideCompletionItems: function (model, position) {
                        var word = model.getWordUntilPosition(position);
                        var range = {
                            startLineNumber: position.lineNumber,
                            endLineNumber: position.lineNumber,
                            startColumn: word.startColumn,
                            endColumn: word.endColumn,
                        };
                
                        const sqlKeywords = [
                            // Standard SQL Keywords
                            "SELECT", "FROM", "WHERE", "INSERT", "UPDATE", "DELETE", "JOIN", 
                            "ORDER BY", "GROUP BY", "HAVING", "DISTINCT", "AS", "AND", "OR", 
                            "NOT", "NULL", "IS", "IN", "EXISTS", "BETWEEN", "CASE", "WHEN", 
                            "THEN", "ELSE", "END", "LIMIT", "OFFSET", "CREATE", "ALTER", 
                            "DROP", "TABLE", "INDEX", "VIEW", "TRIGGER", "PRIMARY KEY", 
                            "FOREIGN KEY", "CHECK", "DEFAULT", "UNIQUE", "WITH", "RECURSIVE",
                            "EXPLAIN", "DESCRIBE", "SHOW", "COMMIT", "ROLLBACK", "TRANSACTION",
                            "SAVEPOINT", "RELEASE", "SET", "LIKE", "ESCAPE", "INTERSECT",
                            "UNION", "EXCEPT", "VALUES", "CROSS JOIN", "NATURAL JOIN",
                            "INNER JOIN", "LEFT JOIN", "RIGHT JOIN", "FULL JOIN", "ON", "USING",

                            // Data Types
                            "INTEGER", "BIGINT", "SMALLINT", "TINYINT", "BOOLEAN", "VARCHAR", 
                            "TEXT", "FLOAT", "DOUBLE", "REAL", "DECIMAL", "NUMERIC", "BLOB", 
                            "DATE", "TIME", "TIMESTAMP", "UUID", "INTERVAL", "ARRAY", "MAP", 
                            "STRUCT", //"JSON",

                            // DuckDB Common Functions
                            "COUNT", "AVG", "MIN", "MAX", "ROUND", "CEIL", "FLOOR", //"SUM", 
                            "ABS", "SIGN", "TRUNCATE", "EXP", "LN", "LOG", "LOG2", "LOG10", 
                            "POWER", "SQRT", "PI", "SIN", "COS", "TAN", "COT", "DEGREES", 
                            "RADIANS", "MOD", "GREATEST", "LEAST", "RANDOM", "SEQUENCE",

                            // String Functions
                            "UPPER", "LOWER", "LENGTH", "SUBSTRING", "POSITION", "TRIM", 
                            "LTRIM", "RTRIM", "REPLACE", "CONCAT", "REPEAT", "LEFT", "RIGHT", 
                            "SPLIT_PART", "REGEXP_MATCHES", "REGEXP_REPLACE", "FORMAT", 
                            "CHAR_LENGTH", "OCTET_LENGTH", "ASCII", "CHR", "ILIKE",

                            // Date & Time Functions
                            "CURRENT_DATE", "CURRENT_TIME", "CURRENT_TIMESTAMP", "DATE_PART", 
                            "DATE_TRUNC", "EXTRACT", "YEAR", "MONTH", "DAY", "HOUR", "MINUTE", 
                            "SECOND", "EPOCH", "AGE", "NOW", "TIMEZONE", "MAKE_DATE", 
                            "MAKE_TIME", "MAKE_TIMESTAMP", "TO_TIMESTAMP", "TO_DATE", 
                            "TO_TIME", "INTERVAL",

                            // Aggregate Functions
                            "GROUP_CONCAT", "ARRAY_AGG", "STRING_AGG", "MEDIAN", "MODE", 
                            "PERCENTILE_CONT", "PERCENTILE_DISC", "STDDEV", "VARIANCE", 
                            "COVAR_POP", "COVAR_SAMP", "CORR", "REGR_SLOPE", "REGR_INTERCEPT",

                            // Window Functions
                            "RANK", "DENSE_RANK", "ROW_NUMBER", "NTILE", "LAG", "LEAD", 
                            "FIRST_VALUE", "LAST_VALUE", "NTH_VALUE", "CUME_DIST", "PERCENT_RANK",

                            // JSON Functions
                            "JSON", "JSON_EXTRACT", "JSON_EXTRACT_SCALAR", "JSON_TYPE", 
                            "JSON_VALID", "JSON_OBJECT", "JSON_ARRAY", "JSON_GROUP_ARRAY",
                            "JSON_GROUP_OBJECT", "JSONB",

                            // Array & Map Functions
                            "ARRAY_LENGTH", "ARRAY_APPEND", "ARRAY_PREPEND", "ARRAY_CONCAT",
                            "ARRAY_POSITION", "ARRAY_REPLACE", "ARRAY_SLICE", "MAP_KEYS", 
                            "MAP_VALUES", "MAP_ENTRIES",

                            // File & Parquet Functions (DuckDB-specific)
                            "READ_CSV", "READ_PARQUET", "READ_JSON", "WRITE_CSV", "WRITE_PARQUET",
                            "WRITE_JSON", "LIST_FILES", "LOAD_EXTENSION", "INSTALL_EXTENSION",

                            // Miscellaneous
                            "CASE WHEN", "CAST", "COALESCE", "NULLIF", "GREATEST",
                            "IFNULL", "IF", "DECODE", "ENCODE", "MD5", "SHA256", "UNNEST", 
                            "TABLESAMPLE", "ANY_VALUE"
                        ];
                
                        return {
                            suggestions: sqlKeywords.map(keyword => ({
                                label: keyword,
                                kind: monaco.languages.CompletionItemKind.Keyword,
                                insertText: keyword + " ", // Adds trailing space
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, // Ensures proper insertion
                                range: range,
                            }))
                        };
                    }
                });
                monaco.languages.registerSignatureHelpProvider('sql', {
                    signatureHelpTriggerCharacters: ['(', ','],
                    provideSignatureHelp: function (model, position) {
                        return {
                            value: {
                                signatures: [
                                    {
                                        label: 'SUM(expression)',
                                        parameters: [
                                            { label: 'expression', documentation: 'A numeric column or expression' }
                                        ]
                                    },
                                    {
                                        label: 'AVG(expression)',
                                        parameters: [
                                            { label: 'expression', documentation: 'A numeric column or expression' }
                                        ]
                                    },
                                    {
                                        label: 'STRING_AGG(expression, delimiter)',
                                        parameters: [
                                            { label: 'expression', documentation: 'A string column or expression' },
                                            { label: 'delimiter', documentation: 'String delimiter used for aggregation' }
                                        ]
                                    },
                                    {
                                        label: 'DATE_TRUNC(unit, date)',
                                        parameters: [
                                            { label: 'unit', documentation: 'Time unit (year, month, day, hour, etc.)' },
                                            { label: 'date', documentation: 'A timestamp or date' }
                                        ]
                                    }
                                ],
                                activeSignature: 0,
                                activeParameter: 0
                            },
                            dispose: () => {}
                        };
                    }
                });
                const sqlKeywordsAndFunctions = {
                    // 🔹 SQL Keywords from Queries
                    "SELECT": {
                        signature: "SELECT columns FROM table",
                        description: "Retrieves data from a table.",
                        example: "Example: `SELECT name, age FROM users;`"
                    },
                    "FROM": {
                        signature: "FROM table",
                        description: "Specifies the source table for the query.",
                        example: "Example: `SELECT * FROM customers;`"
                    },
                    "WHERE": {
                        signature: "WHERE condition",
                        description: "Filters results based on a condition.",
                        example: "Example: `SELECT * FROM users WHERE age > 30;`"
                    },
                    "GROUP BY": {
                        signature: "GROUP BY column",
                        description: "Groups rows that have the same values into summary rows.",
                        example: "Example: `SELECT department, COUNT(*) FROM employees GROUP BY department;`"
                    },
                    "LIMIT": {
                        signature: "LIMIT number",
                        description: "Limits the number of returned rows.",
                        example: "Example: `SELECT * FROM customers LIMIT 100;`"
                    },
                    "INNER JOIN": {
                        signature: "INNER JOIN table ON condition",
                        description: "Returns only matching rows from both tables.",
                        example: "Example:\n```sql\nSELECT p.movie_id, p.title, p.plain_full_script \nFROM read_parquet('movies.parquet') AS p \nINNER JOIN READ_CSV_AUTO('movies.csv') AS c \nON p.movie_id = c.movie_id;\n```"
                    },
                    "USING": {
                        signature: "JOIN table USING (column1, column2, ...)",
                        description: "Joins tables on common column(s) without repeating them.",
                        example: "Example:\n```sql\nSELECT p.movie_id, p.title, p.plain_full_script \nFROM read_parquet('movies.parquet') AS p \nJOIN READ_CSV_AUTO('movies.csv') AS c \nUSING (movie_id, title);\n```"
                    },

                    // 🔹 DuckDB-Specific Keywords
                    "READ_CSV_AUTO": {
                        signature: "READ_CSV_AUTO(file_path)",
                        description: "Automatically reads a CSV file into a DuckDB table.",
                        example: "Example: `SELECT * FROM READ_CSV_AUTO('data.csv');`"
                    },
                    "LOAD": {
                        signature: "LOAD extension",
                        description: "Loads a DuckDB extension.",
                        example: "Example: `LOAD autocomplete;`"
                    },
                    "sql_auto_complete": {
                        signature: "sql_auto_complete(query)",
                        description: "Provides SQL auto-completion for the given query string.",
                        example: "Example: `SELECT * FROM sql_auto_complete('SELECT * FRO');`"
                    },

                    // 🔹 SQL Operators & Clauses
                    "AND": {
                        signature: "condition AND condition",
                        description: "Combines multiple conditions in a WHERE clause.",
                        example: "Example: `SELECT * FROM users WHERE age > 30 AND active = TRUE;`"
                    },
                    "OR": {
                        signature: "condition OR condition",
                        description: "Returns results if at least one condition is met.",
                        example: "Example: `SELECT * FROM users WHERE age > 30 OR active = TRUE;`"
                    },
                    "AS": {
                        signature: "column AS alias",
                        description: "Renames a column or table in the output.",
                        example: "Example: `SELECT name AS customer_name FROM customers;`"
                    },
                    "NOT": {
                        signature: "NOT condition",
                        description: "Negates a condition.",
                        example: "Example: `SELECT * FROM users WHERE NOT active;`"
                    },

                    // 🔹 SQL Functions from Queries
                    "COUNT": {
                        signature: "COUNT(expression)",
                        description: "Returns the count of rows matching the expression.",
                        example: "Example: `SELECT COUNT(*) FROM employees;`"
                    },
                    "AVG": {
                        signature: "AVG(expression)",
                        description: "Returns the average value of a column.",
                        example: "Example: `SELECT AVG(salary) FROM employees;`"
                    },
                    "CAST": {
                        signature: "CAST(expression AS type) or expression::type",
                        description: "Converts an expression to a specified type.",
                        example: "Example: `SELECT 42::STRING;`"
                    },
                    "STRING": {
                        signature: "CAST(expression AS STRING) or expression::STRING",
                        description: "Converts an expression into a string representation.",
                        example: "Example: `SELECT 12345::STRING AS text_value;` or `SELECT CAST(employeenumber AS STRING) FROM employees;`"
                    }
                };

                monaco.languages.registerHoverProvider('sql', {
                    provideHover: function (model, position) {
                        const wordAtPosition = model.getWordAtPosition(position);
                        if (!wordAtPosition) return null; // No word found

                        let word = wordAtPosition.word.toUpperCase(); // Normalize case
                        let previousWord = model.getWordAtPosition(new monaco.Position(position.lineNumber, wordAtPosition.startColumn - 1));
                        let nextWord = model.getWordAtPosition(new monaco.Position(position.lineNumber, wordAtPosition.endColumn + 1));

                        // Try forming a multi-word keyword (previous + current)
                        if (previousWord) {
                            const multiWordKey = previousWord.word.toUpperCase() + " " + word;
                            if (sqlKeywordsAndFunctions[multiWordKey]) {
                                word = multiWordKey;
                            }
                        }

                        // Try forming a multi-word keyword (current + next)
                        if (nextWord) {
                            const multiWordKey = word + " " + nextWord.word.toUpperCase();
                            if (sqlKeywordsAndFunctions[multiWordKey]) {
                                word = multiWordKey;
                            }
                        }

                        if (sqlKeywordsAndFunctions[word]) {
                            return {
                                range: new monaco.Range(
                                    position.lineNumber,
                                    wordAtPosition.startColumn,
                                    position.lineNumber,
                                    wordAtPosition.endColumn
                                ),
                                contents: [
                                    { value: `**${sqlKeywordsAndFunctions[word].signature}**` },
                                    { value: sqlKeywordsAndFunctions[word].description },
                                    { value: sqlKeywordsAndFunctions[word].example }
                                ]
                            };
                        }

                        return null; // No match, no hover info
                    }
                });
                monaco.languages.registerCompletionItemProvider('sql', {
                    provideCompletionItems: function () {
                        return {
                            suggestions: [
                                {
                                    label: 'SUM',
                                    kind: monaco.languages.CompletionItemKind.Function,
                                    insertText: 'SUM(${1:expression})',
                                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                    documentation: 'Returns the sum of a column or expression'
                                },
                                {
                                    label: 'AVG',
                                    kind: monaco.languages.CompletionItemKind.Function,
                                    insertText: 'AVG(${1:expression})',
                                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                    documentation: 'Returns the average of a column or expression'
                                },
                                {
                                    label: 'STRING_AGG',
                                    kind: monaco.languages.CompletionItemKind.Function,
                                    insertText: 'STRING_AGG(${1:expression}, ${2:delimiter})',
                                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                    documentation: 'Aggregates string values with a delimiter'
                                },
                                {
                                    label: 'DATE_TRUNC',
                                    kind: monaco.languages.CompletionItemKind.Function,
                                    insertText: 'DATE_TRUNC(${1:unit}, ${2:date})',
                                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                    documentation: 'Truncates a timestamp to a specified unit'
                                }
                            ]
                        };
                    }
                });
                console.log("DuckDB SQL IntelliSense Enabled");
            } else {
                setTimeout(enableSQLIntelliSense, 100);
            }
        })();
    </script>

<script>
  // Only create the Python Monaco editor after Monaco is loaded, and do not reload Monaco.
  (function waitForMonacoPython() {
    if (window.monacoLoaded && window.monaco && window.monaco.editor) {
      window.pythonEditor = monaco.editor.create(document.getElementById('python-editor'), {
        value: `print("Hello from Python")`,
        language: 'python',
        theme: 'vs-dark',
        automaticLayout: true
      });
    } else {
      setTimeout(waitForMonacoPython, 100);
    }
  })();

  // Wait for Monaco to be loaded for Rust editor initialization
  (function waitForMonacoRust() {
    if (window.monacoLoaded && window.monaco && window.monaco.editor) {
        window.rustEditor = monaco.editor.create(document.getElementById('rust-editor'), {
        value: `fn main() {\n    println!("Hello from Rust!");\n}`,
        language: 'rust',
        theme: 'vs-dark',
        automaticLayout: true
      });
    } else {
      setTimeout(waitForMonacoRust, 100);
    }
  })();

    (function waitForMonacoTerraform() {
    if (window.monacoLoaded && window.monaco && window.monaco.editor) {
        window.terraformEditor = monaco.editor.create(document.getElementById('terraform-editor'), {
        value: `resource "null_resource" "example" {
    provisioner "local-exec" {
        command = "echo Hello from Terraform"
    }
}`,
        language: 'hcl',
        theme: 'vs-dark',
        automaticLayout: true
        });
    } else {
        setTimeout(waitForMonacoTerraform, 100);
    }
    })();

  async function runPythonCode() {
    const pyodide = await loadPyodide();

    // Clear previous outputs
    document.getElementById("python-output").textContent = "";
    document.getElementById("python-plot").innerHTML = "";

    let outputBuffer = "";
    pyodide.setStdout({ batched: (s) => outputBuffer += s });
    pyodide.setStderr({ batched: (s) => outputBuffer += `\n[stderr] ${s}` });

    const code = window.pythonEditor.getValue();

    try {
      // Load required packages
      await pyodide.loadPackage(["pandas", "matplotlib"]);

      await pyodide.runPythonAsync(code);
      // Image extraction logic
      const imgMatch = outputBuffer.match(/__IMG__(.*)/);
      if (imgMatch) {
        const base64 = imgMatch[1];
        document.getElementById("python-plot").innerHTML = `<img src="data:image/png;base64,${base64}" />`;
        document.getElementById("python-output").textContent = outputBuffer.replace(/__IMG__.*/, "").trim();
      } else {
        document.getElementById("python-output").textContent = outputBuffer || "(no output)";
      }
    } catch (e) {
      document.getElementById("python-output").textContent = "Error: " + e;
    }
  }

  function insertPythonExample() {
    editor = window.pythonEditor;
    editor.setValue(`import pandas as pd
import matplotlib.pyplot as plt

data = {
    "Language": ["Python", "C++", "Java", "C", "C#", "JavaScript", "Go", "SQL", "Fortran", "PHP", "Objective-C"],
    "2025": [1, 2, 3, 4, 5, 6, 7, 9, 10, 12, 34],
    "2020": [3, 4, 1, 2, 5, 7, 13, 9, 31, 8, 14],
    "2015": [7, 4, 2, 1, 5, 8, 48, None, 31, 6, 3],
    "2010": [7, 4, 1, 2, 6, 9, 184, None, 25, 3, 13],
    "2005": [9, 3, 2, 1, 10, 11, None, None, 16, 5, 40],
    "2000": [25, 2, 3, 1, 9, 6, None, None, 19, 26, None],
    "1995": [22, 1, None, 2, None, None, None, None, 5, None, None],
    "1990": [None, 3, None, 1, None, None, None, None, 2, None, None],
    "1985": [None, 11, None, 1, None, None, None, None, 6, None, None]
}

df = pd.DataFrame(data)
df_melted = df.melt(id_vars="Language", var_name="Year", value_name="Rank")
df_melted.dropna(inplace=True)
df_melted["Year"] = df_melted["Year"].astype(int)

plt.figure(figsize=(10, 6))
for lang in df["Language"]:
    lang_data = df_melted[df_melted["Language"] == lang]
    plt.plot(lang_data["Year"], lang_data["Rank"], label=lang)

plt.gca().invert_yaxis()
plt.title("TIOBE Language Rankings Over Time")
plt.xlabel("Year")
plt.ylabel("Rank (1 = Most Popular)")
plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left')
plt.tight_layout()
plt.grid(True)
print("Showing Chart from Python")
plt.show()
`);
  }

  window.addEventListener("load", async () => {
    window.pyodide = await loadPyodide();
  });
</script>
<script>
  // Placeholder for Rust code execution. v86 integration will be hooked up here.
  async function runRustCode() {
    const rustCode = window.rustEditor.getValue();
    const rustOutputElement = document.getElementById('rustOutput');
    rustOutputElement.textContent = "⏳ Compiling and running in browser (v86 integration coming soon)...\n";
    // TODO: Integrate v86 to compile/run Rust code in-browser.
  }
  function runTerraformCode() {
    const code = window.terraformEditor.getValue();
    document.getElementById('terraform-output').textContent = "Terraform syntax only demo:\n\n" + code;
  }
</script>
</body>
</html>
